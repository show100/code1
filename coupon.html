// TODO : 코드
// TEST
// TEST
// TEST
// TEST
// TEST

<?php
//------------------------------------------------------------------
/*###############################################*/
$store = $_GET['store']; // 0:신촌, 1:중동, 2:목동
if(empty($store)) $store = 0;

$md = date('nj'); // 쿠키 네임용도zzzzzzzzzzzzzzzzzz
$day = date('j');   // 일 1~31

/* 테스트 용도로 하드코딩. */
//$md = 37;    // 오늘
//$day = 7;     // 시작일
/* 테스트 용도로 하드코딩. */

$key = $day - 7;  // 3월 7일부터 시작afreqwrw

$cp = array();
// 수량은 7일부터 시작으로 아래와 같이 TAB으로 구분했으니 해당 날짜에 맞는 위치를 찾아 수정하면 됩니다.
// (7,8,9    10,11,12,13,14,15,16      ,17,18,19,20,21,22,23    ,24,25,26,27,28,29,30    ,31);
// 신촌
$cp[0][0] = array(5,10,10  ,5,5,5,5,5,10,10    ,5,5,5,5,5,10,10  	,5,5,5,5,5,10,10    ,5);     // 양말
$cp[0][1] = array(3,3,3      ,3,3,3,3,3,3,3        ,3,3,3,3,3,3,3        ,3,3,3,3,3,3,3         ,3);     // 테플론
$cp[0][2] = array(10,10,10    ,10,	10,10,10,10,10,10    ,10,10,10,10,10,10,10    ,10,10,10,10,10,10,10    ,10);     // 1만원 할인권
$cp[0][3] = array(1,2,2      ,1,0,0,0,0,0,0        ,0,0,0,0,0,0,0         ,0,0,0,0,0,0,0        ,0);     // 셜록홈즈2
$cp[0][4] = array(2,2,2      ,1,0,0,0,1,2,2        ,1,1,1,1,0,0,0         ,0,0,0,0,0,0,0        ,0);     // 그녀를 믿지마세요
$cp[0][5] = array(0,0,0      ,0,0,0,0,0,0,0        ,0,0,0,0,0,1,1         ,0,0,1,0,0,1,1        ,0);     // 당신만이
$cp[0][6] = array(0,0,0      ,0,1,1,1,0,0,0        ,0,0,0,0,1,0,0         ,1,1,0,0,0,1,0        ,1);     // 죽여주는 이야기

// 중동
$cp[1][0] = array(5,10,10  ,5,5,5,5,5,10,10    ,5,5,5,5,5,10,10  	,5,5,5,5,5,10,10    ,5);     // 양말
$cp[1][1] = array(3,3,3      ,3,3,3,3,3,3,3        ,3,3,3,3,3,3,3        ,3,3,3,3,3,3,3         ,3);     // 테플론
$cp[1][2] = array(10,10,10    ,10,	10,10,10,10,10,10    ,10,10,10,10,10,10,10    ,10,10,10,10,10,10,10    ,10);     // 1만원 할인권
$cp[1][3] = array(1,2,2      ,1,0,0,0,0,0,0        ,0,0,0,0,0,0,0         ,0,0,0,0,0,0,0        ,0);     // 셜록홈즈2
$cp[1][4] = array(1,1,2      ,0,0,1,0,1,1,2        ,0,0,0,0,1,1,1         ,0,1,1,0,0,1,1        ,0);     // 그녀를 믿지마세요
$cp[1][5] = array(0,0,0      ,0,1,0,0,0,1,0        ,0,1,0,1,0,0,0         ,0,0,0,0,1,0,0        ,0);     // 당신만이
$cp[1][6] = array(0,0,0      ,0,0,0,1,0,0,0        ,0,0,1,0,0,1,0         ,0,0,0,1,0,0,1        ,1);     // 죽여주는 이야기

// 목동
$cp[2][0] = array(5,10,10  ,5,5,5,5,5,10,10    ,5,5,5,5,5,10,10  	,5,5,5,5,5,10,10    ,5);     // 양말
$cp[2][1] = array(3,3,3      ,3,3,3,3,3,3,3        ,3,3,3,3,3,3,3        ,3,3,3,3,3,3,3         ,3);     // 테플론
$cp[2][2] = array(10,10,10    ,10,	10,10,10,10,10,10    ,10,10,10,10,10,10,10    ,10,10,10,10,10,10,10    ,10);     // 1만원 할인권
$cp[2][3] = array(1,2,2      ,1,1,1,0,0,0,0        ,0,0,0,0,0,0,0         ,0,0,0,0,0,0,0        ,0);     // 셜록홈즈2
$cp[2][4] = array(0,0,0      ,0,0,0,0,0,2,1        ,1,1,1,1,1,1,1         ,1,1,1,1,1,2,1        ,0);     // 그녀를 믿지마세요
$cp[2][5] = array(1,0,0      ,0,0,0,1,1,0,0        ,0,0,0,0,0,1,0         ,0,0,0,0,0,0,0        ,1);     // 당신만이
$cp[2][6] = array(0,0,0      ,0,0,0,0,0,0,0        ,0,0,1,0,0,1,1         ,0,0,0,0,0,1,2        ,0);     // 죽여주는 이야기


if(empty($cp[$store][0][$key])){
    $cp[$store][0][$key] = 5; // 양말
    $cp[$store][1][$key] = 3; // 테플론
    $cp[$store][2][$key] = 10; // 1만원 할인권
    $cp[$store][3][$key] = 0; // 셜록홈즈2
    $cp[$store][4][$key] = 0; // 그녀를 믿지마세요
    $cp[$store][5][$key] = 0; // 당신만이
    $cp[$store][6][$key] = 1; // 죽여주는 이야기
}
?>
<!DOCTYPE HTML>
<HTML>
<HEAD>
<TITLE> 쿠폰 발급 </TITLE>
<meta http-equiv="Content-Type" content="text/html; charset=euc-kr" >
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
</HEAD>
<style type="text/css">
#div_box{
    display:block;    border:0px solid #000;    width:450px;    height:300px;    text-align:center;    left:30%;    top: 10%;    position: absolute;
}

#gif_img{
    display:block;    text-align:center;    left:20%;    top: 0%;    position: relative;
}

#btn_news{
    display:block;
    width:160px;
    height:56px;
    margin:0 auto;
    border:0px solid #000;
    border-radius:0px; 
    padding:0;
    background:#EE0000; 
    -webkit-gradient(linear, 0% 0%, 0% 100%, from(#000), to(#000));
    color:#ffffff;
    font-size:12px;
    font-family: "Nanum Gothic"; 
    text-align:center;
    left:0%;
    top: 3%;
    /*position: absolute;*/
    position: relative;
}

.pop-layer {display:none; position: absolute; top: 50%; left: 50%; width: 410px; height:auto;  background-color:#fff; border: 5px solid #3571B5; z-index: 10;}	
.pop-layer .pop-container {padding: 20px 25px;}
.pop-layer p.ctxt {color: #666; line-height: 25px;}
.pop-layer .btn-r {width: 100%; margin:10px 0 0px; padding-top: 10px; border-top: 1px solid #DDD; text-align:right;}

a.cbtn {display:inline-block; height:25px; padding:0 14px 0; border:1px solid #304a8a; background-color:#3f5a9d; font-size:13px; color:#fff; line-height:25px;}	
a.cbtn:hover {border: 1px solid #091940; background-color:#1f326a; color:#fff;}
</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript">
// 레이어 팝업 띄우기
function layer_open(el){

    var temp = $('#' + el);		//레이어의 id를 temp변수에 저장
    var bg = temp.prev().hasClass('bg');	//dimmed 레이어를 감지하기 위한 boolean 변수

    if(bg){
        $('.layer').fadeIn();
    }else{
        temp.fadeIn();	//bg 클래스가 없으면 일반레이어로 실행한다.
    }
    //get_coupon();
    set_coupon();

    // 화면의 중앙에 레이어를 띄운다.
    if (temp.outerHeight() < $(document).height() ) temp.css('margin-top', '-'+temp.outerHeight()/2+'px');
    else temp.css('top', '0px');
    if (temp.outerWidth() < $(document).width() ) temp.css('margin-left', '-'+temp.outerWidth()/2+'px');
    else temp.css('left', '0px');

    // close button click
    temp.find('a.cbtn').click(function(e){
        if(bg){
            $('.layer').fadeOut();
        }else{
            temp.fadeOut();		//'닫기'버튼을 클릭하면 레이어가 사라진다.
        }
        e.preventDefault();
        document.location.reload();
    });

    $('.layer .bg').click(function(e){
        $('.layer').fadeOut();
        e.preventDefault();
    });

}				

// 쿠키 생성
function setCookie(cName, cValue, cDay){
  var expire = new Date();
  expire.setDate(expire.getDate() + cDay);
  cookies = cName + '=' + escape(cValue) + '; path=/ '; // 한글 깨짐을 막기위해 escape(cValue)를 합니다.
  if(cDay != 'undefined') cookies += ';expires=' + expire.toGMTString() + ';';
  document.cookie = cookies;
}

// 쿠키 가져오기
function getCookie(cName) {
  cName = cName + '=';
  var cookieData = document.cookie;
  var start = cookieData.indexOf(cName);
  var cValue = '';
  if(start != -1){
       start += cName.length;
       var end = cookieData.indexOf(';', start);
       if(end == -1)end = cookieData.length;
       cValue = cookieData.substring(start, end);
  }
  return unescape(cValue);
}


var giveaway = new Array();
var coupon = new Array();

// 쿠키 값 없으면 날짜별 설정 수량으로 셋팅
function set_ea(){
    var frm = document.cForm;
    var coupon0 = "store<?php echo $store;?>_<?php echo $md;?>_0";
    var coupon1 = "store<?php echo $store;?>_<?php echo $md;?>_1";
    var coupon2 = "store<?php echo $store;?>_<?php echo $md;?>_2";
    var coupon3 = "store<?php echo $store;?>_<?php echo $md;?>_3";
    var coupon4 = "store<?php echo $store;?>_<?php echo $md;?>_4";
    var coupon5 = "store<?php echo $store;?>_<?php echo $md;?>_5";
    var coupon6 = "store<?php echo $store;?>_<?php echo $md;?>_6";

    if(getCookie(coupon0) == ''){
        giveaway[0] = <?php echo $cp[$store][0][$key];?>;
        setCookie(coupon0, giveaway[0], 1);
    }else{
        giveaway[0] = getCookie(coupon0);
    }

    if(getCookie(coupon1) == ''){
        giveaway[1] = <?php echo $cp[$store][1][$key];?>;
        setCookie(coupon1, giveaway[1], 1);
    }else{
        giveaway[1] = getCookie(coupon1);
    }

    if(getCookie(coupon2) == ''){
        giveaway[2] = <?php echo $cp[$store][2][$key];?>;
        setCookie(coupon2, giveaway[2], 1);
    }else{
        giveaway[2] = getCookie(coupon2);
    }

    if(getCookie(coupon3) == ''){
        giveaway[3] = <?php echo $cp[$store][3][$key];?>;
        setCookie(coupon3, giveaway[3], 1);
    }else{
        giveaway[3] = getCookie(coupon3);
    }

    if(getCookie(coupon4) == ''){
        giveaway[4] = <?php echo $cp[$store][4][$key];?>;
        setCookie(coupon4, giveaway[4], 1);
    }else{
        giveaway[4] = getCookie(coupon4);
    }

    if(getCookie(coupon5) == ''){
        giveaway[5] = <?php echo $cp[$store][5][$key];?>;
        setCookie(coupon5, giveaway[5], 1);
    }else{
        giveaway[5] = getCookie(coupon5);
    }

    if(getCookie(coupon6) == ''){
        giveaway[6] = <?php echo $cp[$store][6][$key];?>;
        setCookie(coupon6, giveaway[6], 1);
    }else{
        giveaway[6] = getCookie(coupon6);
    }
}


function set_coupon(){
    var i;
    // 쿠폰 이미지
    var imgs = [
        "http://www.ibkshmall.co.kr/ibkshmall/shopping_new/p_img/500/961737_5.JPG",    // 양말
        "http://cfile29.uf.tistory.com/image/2601E04A53018232125886",      // 테플론 셔츠 1매
        "http://www.econovill.com/wp-content/uploads/2013/07/20130719-17370369214.jpg",     // 1만원 할인권
        "http://pds15.egloos.com/pds/201002/01/80/b0000880_4b65f56e2d6bb.jpg",      // 셜록홈즈2
        "http://www.artz.co.kr/data/culture/play/13007419_p_140121125436.jpg",      // 그녀를 믿지마세요
        "http://files.youngsamsung.com/uploads/kdkd/attach/20120316/make_1331828991353.jpg",      // 당신만이
        "http://cfile7.uf.tistory.com/image/151F763D4F3C92982C5C02"      // 죽여주는 이야기
    ];

    if(giveaway[0]>0)
        for(i=0; i<giveaway[0]; i++){ coupon.push(0); }

    if(giveaway[1]>0)
        for(i=0; i<giveaway[1]; i++){ coupon.push(1); }

    if(giveaway[2]>0)
        for(i=0; i<giveaway[2]; i++){ coupon.push(2); }

    if(giveaway[3]>0)
        for(i=0; i<giveaway[3]; i++){ coupon.push(3); }

    if(giveaway[4]>0)
        for(i=0; i<giveaway[4]; i++){ coupon.push(4); }

    if(giveaway[5]>0)
        for(i=0; i<giveaway[5]; i++){ coupon.push(5); }

    if(giveaway[6]>0)
        for(i=0; i<giveaway[6]; i++){ coupon.push(6); }

    // 당일치 모두 소진시 양말로 셋팅
    if(coupon.length <= 0)
        coupon.push(0);

    coupon.sort(function(){
        return Math.random() - Math.random();
    });
    var rand = Math.floor(Math.random() * coupon.length);
    //alert("coupon : "+ coupon[rand]);

    var coupon_id = document.getElementById("coupon");
    coupon_id.innerHTML = "<img src='"+imgs[coupon[rand]]+"' width='300' height='150' />";

    var cookie_name = "store<?php echo $store;?>_<?php echo $md;?>_"+coupon[rand];
    var cookie_value = giveaway[coupon[rand]] - 1; 
    if(cookie_value <= 0)
        cookie_value = 0;

    setCookie(cookie_name, cookie_value, 90);
}

// 쿠폰 수량 셋팅
set_ea();
</script>
<BODY>

<div id="div_box">
    <img src="https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTWoaOf81FnuMCMoBSdghW2mZWN6bGclakbSIfhTUFQw88PUYWe" id="gif_img" width="250" height="250" />
    <input id="btn_news" type="button" class="btn_news"  value="쿠폰발급" style='cursor:hand' onclick="layer_open('layer1');return false;">
</div>

<div id="layer1" class="pop-layer">
	<div class="pop-container">
		<div class="pop-conts">
			<!--content //-->
            <div id="coupon" style="text-align:center;"></div>
			<div class="btn-r">
				<a href="#" class="cbtn">Close</a>
			</div>
			<!--// content-->
		</div>
	</div>
</div>




<!-- <form name="cForm">
<pre>
지점 : <select name="area">
    <option value="store1">신촌점</option>
    <option value="store2">중동점</option>
    <option value="store3">목동점</option>
</select>
1. 사은품 양말 증정 <input type="text" size="2" name="giveaway0" value="0" /> 개
2. 테플론 셔츠 1매 9900원 (바로 구매시) <input type="text" size="2" name="giveaway1" value="0" /> 개
3. poemier (더셔츠스튜디오) 1만원 할인권 <input type="text" size="2" name="giveaway2" value="0" /> 개
4. 뮤지컬 셜록홈즈2 : 블러디 게임 <input type="text" size="2" name="giveaway3" value="0" /> 개
5. 연극 - 그녀를 믿지마세요 <input type="text" size="2" name="giveaway4" value="0" /> 개
6. 연극- 당신만이 <input type="text" size="2" name="giveaway5" value="0" /> 개
7. 연극- 죽여주는 이야기 <input type="text" size="2" name="giveaway6" value="0" /> 개
<input type="button" value="정보저장" onclick="set_coupon();" />
</pre>
</form> -->

</BODY>
</HTML>
